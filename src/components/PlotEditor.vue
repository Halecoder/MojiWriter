<!-- Â§áÂøòÂΩïÁºñËæëÊ®°Âùó -->
<template>
    <PopupMenu
        v-if="isNewPlotGroup"
        :title="panelName_Plot"
        determine="Á°ÆÂÆö"
        @toModify="modify"
        @toDetermine="plotReName"
        :determineDisabled="curPlotName.length === 0"
    >
        <a-form-item field="event" label="Â§áÂøòÂΩïÂêç">
            <a-input
                v-model="curPlotName"
                :max-length="20"
                placeholder="ËØ∑Â°´ÂÜôÂ§áÂøòÂΩïÂêç"
                allow-clear
                show-word-limit
            ></a-input>
        </a-form-item>
    </PopupMenu>
    <PopupMenu
        v-if="isGroupReName"
        :title="panelName_Group!"
        determine="Á°ÆÂÆö"
        @toModify="modify"
        @toDetermine="groupReName"
        :determineDisabled="curGroupName.length === 0"
    >
        <a-form-item field="event" label="ÂæÖÂäûÁªÑÂêç">
            <a-input
                v-model="curGroupName"
                :max-length="20"
                placeholder="ËØ∑Â°´ÂÜôÁªÑÂêç"
                allow-clear
                show-word-limit
            ></a-input>
        </a-form-item>
    </PopupMenu>
    <PopupMenu
        v-if="isNewSummaryItem"
        :title="panelName_summary!"
        determine="Á°ÆÂÆö"
        @toModify="modify"
        @toDetermine="editSummaryItem"
        :determineDisabled="summaryForm.title.length === 0"
    >
        <a-form :model="summaryForm" style="overflow: hidden;" layout="inline">
            <a-form-item field="imp" label="ÈáçË¶ÅÊÄß">
                <a-rate v-model="summaryForm.imp" title="ÈÄâÊã©ÈáçË¶ÅÊÄß(1-5)" :count="5">
                    <template #character>
                        <icon-fire />
                    </template>
                </a-rate>
            </a-form-item>
            <a-form-item field="title" label="Ê†áÈ¢ò">
                <a-input
                    :max-length="15"
                    v-model="summaryForm.title"
                    placeholder="ËØ∑Â°´ÂÜô‰∫ãÈ°πÊ†áÈ¢ò"
                    size="samll"
                    style="width: 200px;"
                    allow-clear
                    show-word-limit
                />
            </a-form-item>
            <a-form-item field="con" label="ÊèèËø∞">
                <a-textarea
                    v-model="summaryForm.con"
                    placeholder="Â°´ÂÜô‰∫ãÈ°πÊèèËø∞"
                    :auto-size="{
                        minRows: 5,
                        maxRows: 5
                    }"
                    style="width: 450px;"
                    :max-length="500"
                    show-word-limit
                    allow-clear
                />
            </a-form-item>
        </a-form>
    </PopupMenu>
    <div class="plot">
        <a-resize-box :directions="['left', 'right']" class="resize-box">
            <template #resize-trigger="{ direction }">
                <div :class="[`resizebox-demo`, `resizebox-demo-${'vertical'}`]">
                    <div class="resizebox-demo-line" />
                </div>
            </template>
            <div class="container">
                <div class="head">
                    <a-tabs
                        v-if="tabsData.length > 0"
                        type="text"
                        @change="chocieTab"
                        @delete="deletePlotGroup"
                        :editable="true"
                    >
                        <template #extra>
                            <a-button
                                @click="showNewPlotGroup('rename')"
                                type="text"
                                size="small"
                                title="‰øÆÊîπÂ§áÂøòÂΩï"
                            >Edit</a-button>
                            <a-button
                                @click="showNewPlotGroup('add')"
                                type="text"
                                size="small"
                                title="Ê∑ªÂä†Â§áÂøòÂΩï"
                            >Add</a-button>
                        </template>
                        <a-tab-pane v-for="item in tabsData" :key="item[0]" :title="item[1]"></a-tab-pane>
                    </a-tabs>
                </div>
                <details
                    v-if="thePlotData.data.length > 0"
                    v-for="item in thePlotData.data[nowPlotKey].summary"
                    :key="item.sid"
                >
                    <!-- Â§ßÊ†áÈ¢ò -->
                    <a-dropdown
                        trigger="contextMenu"
                        alignPoint
                        :style="{ display: 'block', fontSize: '14px' }"
                    >
                        <summary title="Êåâ‰ΩèshiftÂπ∂ÁÇπÂáªÂèØÂ§öÈ°πÂ±ïÂºÄ">
                            <span class="summary-title">{{ item.itemsName }}</span>
                        </summary>
                        <template #content>
                            <a-doption
                                @click="openEditSummaryItem(item.sid, null)"
                                class="iconfont"
                            >&#xe648;&nbsp;&nbsp;Ê∑ªÂä†Êñ∞Êù°ÁõÆ</a-doption>
                            <a-doption
                                @click="openGroupReName(item.itemsName, item.sid, 'add')"
                                class="iconfont"
                            >&#xe616;&nbsp;&nbsp;Ê∑ªÂä†Êñ∞ÁªÑ</a-doption>
                            <a-doption
                                @click="openGroupReName(item.itemsName, item.sid, 'rename')"
                                class="iconfont"
                            >&#xe82a;&nbsp;&nbsp;ÈáçÂëΩÂêç</a-doption>
                            <a-doption
                                @click="deleteGroup(item.itemsName, item.sid)"
                                class="iconfont"
                            >&#xe7f2;&nbsp;&nbsp;Âà†Èô§</a-doption>
                        </template>
                    </a-dropdown>
                    <!-- ÂÜÖÂÆπÂå∫ -->
                    <ul @click.stop>
                        <li v-for="(it, i) in item.items" :key="i">
                            <div class="summary-content">
                                <span class="title">
                                    <span
                                        @click="switchComStatu(item.sid, i)"
                                        style="display: inline;cursor: pointer;"
                                        :title="it.complete ? 'Â∑≤ÂÆåÊàê' : 'ÂæÖÂÆåÊàê'"
                                    >{{ it.complete ? '‚úÖ' : 'üî¥' }}</span>
                                    {{ it.title }}
                                    <span
                                        @click="openEditSummaryItem(item.sid, i)"
                                        class="edit-btn"
                                    >
                                        <icon-edit />
                                    </span>
                                    <span
                                        @click="deleteSummaryItem(it.title, item.sid, i)"
                                        class="edit-btn"
                                    >
                                        <icon-delete />
                                    </span>
                                </span>
                                <span class="status">{{ statusGenerat(it.imp) }}</span>
                                <span class="info">{{ it.con }}</span>
                            </div>
                        </li>
                    </ul>
                </details>
            </div>
        </a-resize-box>
    </div>
</template>

<script setup lang="ts">
import { IconFire, IconEdit, IconDelete } from '@arco-design/web-vue/es/icon';
import { computed, nextTick, reactive, ref, Ref } from 'vue';
import { useRoute } from 'vue-router';
import PopupMenu from './widget/PopupMenu.vue';
import useCurrentInstance from '../utils/useCurrentInstance';
import { db } from '../db/db';
import { v4 } from 'uuid';

const { proxy } = useCurrentInstance();
const route = useRoute();
const query_id = parseInt(<string>route.query.id);
const thePlotData: { data: Array<PlotGroup> } = reactive({ data: [] });
const tabsData: Ref<Array<Array<string>>> = ref([]);
const nowPlotKey = ref(0); // ÂΩìÂâçÊ∏≤ÊüìÊï∞ÊçÆÁöÑÁ¥¢Âºï

loadPlotData();

/* ----------------------- tabÂèäÂÜÖÂÆπÁõ∏ÂÖ≥-----------------------*/
// ËÆ°ÁÆóÈáçË¶ÅÊÄßÂ≠óÁ¨¶‰∏™Êï∞
const statusGenerat = (qua: number) => {
    let str = '';
    for (let i = 0; i < qua; i++) {
        str += 'üî•';
    }
    return str;
}

// ÈÄâÊã©tabÂàáÊç¢Á∫ø
const chocieTab = (key: string) => {
    thePlotData.data.forEach((item, index) => {
        if (item.id === key) nowPlotKey.value = index;
    })
}

// Ê∑ªÂä†Êñ∞Â§áÂøòÂΩï
const isNewPlotGroup = ref(false), curPlotName = ref('');
const panelName_Plot = ref('Êñ∞Âª∫Â§áÂøòÂΩï');
const mode_plot: Ref<'add' | 'rename'> = ref('add');
const showNewPlotGroup = (mode: 'add' | 'rename') => {
    isNewPlotGroup.value = true;
    mode_plot.value = mode;
    if (mode === 'add') {
        panelName_Plot.value = 'Êñ∞Âª∫Â§áÂøòÂΩï';
        curPlotName.value = '';
    } else if (mode === 'rename') {
        panelName_Plot.value = '‰øÆÊîπÂ§áÂøòÂΩï';
        curPlotName.value = thePlotData.data[nowPlotKey.value].name;
    }
}
const plotReName = () => {
    if (mode_plot.value === 'add') {
        loadDB('Ê∑ªÂä†Êñ∞Â§áÂøòÂΩïÊàêÂäüÔºÅ', (item: Userdb) => {
            item.thePlot.push({
                id: v4(),
                name: curPlotName.value,
                summary: [{
                    sid: v4(),
                    itemsName: 'Ëá™ÂÆö‰πâÂæÖÂäûÁªÑ',
                    items: []
                }]
            });
        })
    } else if (mode_plot.value === 'rename') {
        loadDB('‰øÆÊîπÂ§áÂøòÂΩïÊàêÂäüÔºÅ', (item: Userdb) => {
            item.thePlot[nowPlotKey.value].name = curPlotName.value;
        })
    }
    // Â±ÄÈÉ®Â§ÑÁêÜÂáΩÊï∞
    function loadDB(msg: string, cb: Function) {
        db.opus.where(':id').equals(query_id).modify(item => {
            cb(item);
        }).then(() => {
            isNewPlotGroup.value = false;
            proxy.$message.success(msg);
            loadPlotData();
        })
    }
}
// Âà†Èô§Â§áÂøòÂΩï
const deletePlotGroup = (key: string) => {
    if (thePlotData.data.length > 1) {
        for (let index in thePlotData.data) {
            if (thePlotData.data[index].id === key) {
                proxy.$modal.warning({
                    title: "Âà†Èô§Â§áÂøòÂΩï",
                    content: `ÊòØÂê¶Âà†Èô§"${thePlotData.data[index].name}"? ËØ•Êìç‰Ωú‰∏çÂèØÈÄÜ!`,
                    simple: true,
                    onOk: () => {
                        db.opus.where(':id').equals(query_id).modify(item => {
                            item.thePlot.splice(parseInt(index), 1);
                        }).then(() => {
                            proxy.$message.success('Âà†Èô§ÊàêÂäüÔºÅ');
                            if (key === thePlotData.data[nowPlotKey.value].id) nowPlotKey.value = 0;
                            loadPlotData();
                        })
                    }
                })
            }
        }
    } else {
        proxy.$message.error('ÊúÄÂêé‰∏Ä‰∏™Êó†Ê≥ïÂà†Èô§ÔºÅ');
    }
}
// ÂàáÊç¢ÂÆåÊàêÁä∂ÊÄÅ
const switchComStatu = (sid: string, i: number) => {
    db.opus.where(':id').equals(query_id).modify(item => {
        item.thePlot[nowPlotKey.value].summary.forEach(it => {
            if (it.sid === sid) it.items[i].complete = !it.items[i].complete;
        })
    }).then(() => {
        loadPlotData();
    })
}

/* ----------------------- ÊâìÂºÄÂæÖÂäûÁªÑÈáçÂëΩÂêçÈù¢Êùø-----------------------*/
const isGroupReName = ref(false);
const curGroupName = ref(''), curSid = ref(''); // ÂΩìÂâçÁöÑÁõÆÊ†áÁªÑÂêçÂèäÂÖ∂ÂØπÂ∫îsid
const mode_group: Ref<'add' | 'rename'> = ref('add');
const panelName_Group = computed(() => {
    if (mode_group.value === 'add') return 'Ê∑ªÂä†Êñ∞ÁªÑ';
    if (mode_group.value === 'rename') return 'ÈáçÂëΩÂêç';
})
const openGroupReName = (name: string, sid: string, type: 'add' | 'rename') => {
    mode_group.value = type;
    [isGroupReName.value, curGroupName.value, curSid.value] = [true, name, sid]
}
// ÂæÖÂäûÁªÑÈáçÂëΩÂêç/Ê∑ªÂä†
const groupReName = () => {
    if (mode_group.value === 'rename') {
        loadDB('ÈáçÂëΩÂêçÊàêÂäüÔºÅ', (item: Userdb) => {
            item.thePlot[nowPlotKey.value].summary.forEach(it => {
                if (it.sid === curSid.value) it.itemsName = curGroupName.value;
            })
        })
    } else if (mode_group.value = 'add') {
        loadDB('Ê∑ªÂä†ÁªÑÊàêÂäüÔºÅ', (item: Userdb) => {
            item.thePlot[nowPlotKey.value].summary.push({
                sid: v4(),
                itemsName: curGroupName.value,
                items: []
            })
        })
    }
    // Â±ÄÈÉ®Â§ÑÁêÜÂáΩÊï∞
    function loadDB(msg: string, cb: Function) {
        db.opus.where(':id').equals(query_id).modify(item => {
            cb(item);
        }).then(() => {
            isGroupReName.value = false;
            proxy.$message.success(msg);
            loadPlotData();
        })
    }
}
// Âà†Èô§ÁõÆÊ†áÂæÖÂäûÁªÑ
const deleteGroup = (name: string, sid: string) => {
    proxy.$modal.warning({
        title: 'Âà†Èô§ÂæÖÂäûÁªÑ',
        content: `ÊòØÂê¶Âà†Èô§ÂæÖÂäûÁªÑ"${name}"? ËØ•Êìç‰Ωú‰∏çÂèØÈÄÜ!`,
        simple: true,
        onOk: () => {
            db.opus.where(':id').equals(query_id).modify(item => {
                item.thePlot[nowPlotKey.value].summary.forEach((it, index) => {
                    if (it.sid === sid) item.thePlot[nowPlotKey.value].summary.splice(index, 1);
                })
            }).then(() => {
                proxy.$message.success('Âà†Èô§ÊàêÂäüÔºÅ');
                loadPlotData();
            })
        }
    })
}

/* ----------------------- ÊâìÂºÄÁªÑÂÜÖÊù°ÁõÆËÆæÁΩÆÈù¢Êùø-----------------------*/
const isNewSummaryItem = ref(false);
const mode_item: Ref<'add' | 'edit'> = ref('add');
const summaryIndex: Ref<number | null> = ref(0);
const summaryForm = reactive({
    title: '',
    imp: 1,
    con: ''
});
const panelName_summary = computed(() => {
    if (mode_item.value === 'add') return 'Ê∑ªÂä†Êñ∞Êù°ÁõÆ';
    if (mode_item.value === 'edit') return 'ÁºñËæëÈÄâÊã©Êù°ÁõÆ';
})
// ÊâìÂºÄÊù°ÁõÆÈù¢Êùø
const openEditSummaryItem = (sid: string, index: number | null) => {
    if (index === null) {
        mode_item.value = 'add';
    } else {
        mode_item.value = 'edit';
        thePlotData.data[nowPlotKey.value].summary.forEach(item => {
            if (item.sid === sid) {
                summaryForm.title = item.items[index].title;
                summaryForm.imp = item.items[index].imp;
                summaryForm.con = item.items[index].con;
            }
        })
    }
    summaryIndex.value = index;
    isNewSummaryItem.value = true;
    curSid.value = sid;
}
const editSummaryItem = () => {
    if (mode_item.value === 'add') {
        loadDB('Ê∑ªÂä†ÊàêÂäüÔºÅ', (it: Summary) => {
            it.items.push({
                title: summaryForm.title,
                imp: summaryForm.imp,
                con: summaryForm.con,
                complete: false
            })
        })
    } else if (mode_item.value === 'edit') {
        loadDB('‰øÆÊîπÊàêÂäüÔºÅ', (it: Summary) => {
            it.items[summaryIndex.value!].title = summaryForm.title;
            it.items[summaryIndex.value!].imp = summaryForm.imp;
            it.items[summaryIndex.value!].con = summaryForm.con;
        })
    }
    // Â±ÄÈÉ®Â§ÑÁêÜÂáΩÊï∞
    function loadDB(msg: string, cb: Function) {
        db.opus.where(':id').equals(query_id).modify(item => {
            item.thePlot[nowPlotKey.value].summary.forEach(it => {
                if (it.sid === curSid.value) {
                    cb(it);
                };
            })
        }).then(() => {
            isNewSummaryItem.value = false;
            proxy.$message.success(msg);
            loadPlotData();
        })
    }
}
// Âà†Èô§ÁõÆÊ†áÊù°ÁõÆ
const deleteSummaryItem = (name: string, sid: string, index: number) => {
    proxy.$modal.warning({
        title: 'Âà†Èô§Êù°ÁõÆ',
        content: `ÊòØÂê¶Âà†Èô§ÁõÆÊ†áÊù°ÁõÆ"${name}"? ËØ•Êìç‰Ωú‰∏çÂèØÈÄÜ!`,
        simple: true,
        onOk: () => {
            db.opus.where(':id').equals(query_id).modify(item => {
                item.thePlot[nowPlotKey.value].summary.forEach(it => {
                    if (it.sid === sid) it.items.splice(index, 1);
                })
            }).then(() => {
                proxy.$message.success('Âà†Èô§ÊàêÂäüÔºÅ');
                loadPlotData();
            })
        }
    })
}

const modify = () => {
    isNewPlotGroup.value = false;
    isGroupReName.value = false;
    isNewSummaryItem.value = false;
}

// Ëé∑ÂèñÊï∞ÊçÆ
function loadPlotData(): void {
    db.opus.get(query_id).then(value => {
        if (value) {
            thePlotData.data = value.thePlot;
            tabsData.value = thePlotData.data.map(item => [item.id, item.name]);
        };
    }).then(() => {
        nextTick(() => {
            let ds = [...document.querySelectorAll('details')];
            // ÈªòËÆ§ÊØèÊ¨°Âè™ËÉΩÊúâ‰∏Ä‰∏™Â±ïÂºÄ
            ds.forEach(d => {
                d.addEventListener('click', e => {
                    // Êåâ‰ΩèshiftÂèØ‰ª•Â±ïÂºÄÂ§ö‰∏™
                    e.shiftKey || ds.filter(i => i != d).forEach(i => i.removeAttribute('open'))
                })
            })
        })
    })
}
</script>
<style src="../style/ploteditor.scss" lang="scss" scoped>
</style>
