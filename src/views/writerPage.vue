<!-- ‰ΩúÂìÅ(Á∫ØÊñáÊú¨)ÁºñÂÜôÈ°µ -->
<template>
    <TitleBlock v-show="!fullScreenState"></TitleBlock>
    <KeywordDetail
        v-if="showkeywordDetail"
        @getkeywordDetail="getkeywordDetail"
        @displayKeyPanel="displayKeyPanel"
        ref="keywordDetailRef"
    ></KeywordDetail>
    <PopupMenu
        v-if="isRename"
        title="ÈáçÂëΩÂêç"
        determine="Á°ÆÂÆö"
        @toModify="modify"
        @toDetermine="reName"
        :determineDisabled="showName.length === 0"
    >
        <a-space>
            <a-form-item field="name" label="ÂêçÁß∞">
                <a-input
                    v-model.trim="showName"
                    style="width: 370px"
                    :max-length="25"
                    :error="showName.length === 0"
                    show-word-limit
                    allow-clear
                    placeholder="ËØ∑ËæìÂÖ•Á´†Âêç..."
                />
            </a-form-item>
        </a-space>
    </PopupMenu>
    <PopupMenu
        v-if="isNewVolume"
        title="Êñ∞Â¢ûÂç∑"
        determine="Á°ÆÂÆö"
        @toModify="modify"
        @toDetermine="addNewVolume"
        :determineDisabled="volumeName.length === 0"
    >
        <a-space>
            <a-form-item field="name" label="Âç∑Âêç">
                <a-input
                    v-model.trim="volumeName"
                    style="width: 370px"
                    :max-length="25"
                    :error="volumeName.length === 0"
                    show-word-limit
                    allow-clear
                    placeholder="ËØ∑ËæìÂÖ•Âç∑Âêç..."
                />
            </a-form-item>
        </a-space>
    </PopupMenu>
    <PopupMenu
        v-if="isNewChapter"
        title="Êñ∞Â¢ûÁ´†"
        determine="Á°ÆÂÆö"
        @toModify="modify"
        @toDetermine="addNewChapter"
        :determineDisabled="chapterName.length === 0"
    >
        <a-space>
            <a-form-item field="name" label="Á´†Âêç">
                <a-input
                    v-model.trim="chapterName"
                    style="width: 370px"
                    :max-length="25"
                    :error="chapterName.length === 0"
                    show-word-limit
                    allow-clear
                    placeholder="ËØ∑ËæìÂÖ•Á´†Âêç..."
                />
            </a-form-item>
        </a-space>
    </PopupMenu>
    <div class="layout-write">
        <a-layout>
            <a-layout-header v-show="!fullScreenState">
                <TopToolbar @fullscreen="turnfullScreen" ref="topToolRef"></TopToolbar>
            </a-layout-header>
            <a-layout>
                <a-layout-sider
                    collapsible
                    :collapsed="isCollapse"
                    @collapse="onCollapse"
                    class="siderLeft-w"
                >
                    <a-menu
                        :default-open-keys="[vid]"
                        :default-selected-keys="[cid]"
                        :style="{ width: '100%', textAlign: 'left' }"
                    >
                        <button
                            @click="isNewVolume = true"
                            class="topBtn"
                        >üìú&nbsp;{{ isCollapse ? '' : 'Ê∑ªÂä†Âç∑' }}</button>
                        <a-sub-menu v-for="item in booksLists.data" :key="item.vid">
                            <template #title>
                                <icon-right-circle
                                    @click.stop="showLeftMore = showLeftMore === item.vid ? '' : item.vid"
                                    class="siderLeft-btn"
                                />
                                <span title="Âà†Èô§Âç∑">
                                    <svg
                                        v-if="showLeftMore === item.vid"
                                        viewBox="0 0 1024 1024"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        style="margin-bottom: -5px; margin-right: 5px;margin-left: 5px;"
                                        @mouseenter="editVid1 = item.vid"
                                        @mouseleave="editVid1 = ''"
                                        @click.stop="deleteVolume(item.vid, item.volumeName)"
                                    >
                                        <path
                                            p-id="3022"
                                            :fill="editVid1 === item.vid ? '#bf5e00' : '#ff7d00'"
                                        />
                                    </svg>
                                </span>
                                <span title="ÈáçÂëΩÂêç">
                                    <svg
                                        v-if="showLeftMore === item.vid"
                                        viewBox="0 0 1024 1024"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        style="margin-bottom: -5px; margin-right: 5px;"
                                        @mouseenter="editVid2 = item.vid"
                                        @mouseleave="editVid2 = ''"
                                        @click.stop="showReName('v', item.vid, item.volumeName)"
                                    >
                                        <path
                                            :fill="editVid2 === item.vid ? '#276dbc' : '#3491fa'"
                                            p-id="3276"
                                        />
                                    </svg>
                                </span>
                                <span title="Êñ∞Â¢ûÁ´†">
                                    <svg
                                        v-if="showLeftMore === item.vid"
                                        viewBox="0 0 1024 1024"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="18"
                                        height="18"
                                        style="margin-bottom: -4px; margin-right: 5px;"
                                        @mouseenter="editVid3 = item.vid"
                                        @mouseleave="editVid3 = ''"
                                        @click.stop="newChapter(item.vid)"
                                    >
                                        <path
                                            p-id="1550"
                                            :fill="editVid3 === item.vid ? '#008720' : '#00b42a'"
                                        />
                                    </svg>
                                </span>
                                {{ item.volumeName }}
                            </template>
                            <a-dropdown
                                v-for="it in item.volume"
                                :key="it.cid"
                                trigger="contextMenu"
                                alignPoint
                                :style="{ display: 'block' }"
                            >
                                <a-menu-item
                                    :key="it.cid"
                                    @click="onClickMenuItem(item.vid, it.cid)"
                                    :style="deletedCid === it.cid ? 'color:#f53f3f;text-decoration:line-through;text-indent:10px;' : 'text-indent:10px;'"
                                    :title="it.chapterName"
                                >{{ it.chapterName }}</a-menu-item>
                                <template #content>
                                    <a-doption
                                        @click="showReName('c', it.cid, it.chapterName)"
                                        class="iconfont"
                                    >&#xe82a;&nbsp;&nbsp;ÈáçÂëΩÂêç</a-doption>
                                    <a-doption
                                        @click="deleteChapter(item.vid, it.cid, it.chapterName)"
                                        class="iconfont"
                                    >&#xe7f2;&nbsp;&nbsp;Âà†Èô§Á´†</a-doption>
                                </template>
                            </a-dropdown>
                        </a-sub-menu>
                    </a-menu>
                    <template #trigger="{ collapsed }">
                        <IconCaretRight v-if="collapsed"></IconCaretRight>
                        <IconCaretLeft v-else></IconCaretLeft>
                    </template>
                </a-layout-sider>
                <a-layout-content
                    @mouseover="showScroll"
                    @mouseout="closeScroll"
                    @scroll="getScrollTop"
                >
                    <div
                        v-if="!showSiderRight"
                        @click="openTheSide"
                        class="open-button"
                        title="Â±ïÂºÄÂè≥‰æß Ctrl+Shift+["
                    >
                        <icon-left :stroke-width="2" />
                    </div>
                    <SearchBox v-if="showSearchBox" @close="closeSearch" ref="searchBoxRef"></SearchBox>
                    <WritingPaper
                        @todata="sendPaperData"
                        @addKeyWord="addKeyWord"
                        @toWebView="toWebView"
                        ref="paperRef"
                    ></WritingPaper>
                </a-layout-content>
                <a-resize-box
                    @moving-start="showIframeWrap = true"
                    @moving-end="showIframeWrap = false"
                    @moving="resizeBoxMoving"
                    :directions="['left']"
                    class="sider-right"
                    :style="{ minWidth: '250px' }"
                    v-model:width="resizeBoxWdith"
                    v-show="showSiderRight"
                >
                    <!-- ‰º∏Áº©ÊùÜ -->
                    <template #resize-trigger="{ direction }">
                        <div
                            :class="[
                                `resizebox-demo`,
                                `resizebox-demo-${direction === 'left' ? 'vertical' : 'horizontal'}`
                            ]"
                        >
                            <div class="resizebox-demo-line" />
                        </div>
                    </template>
                    <!-- ÂÜÖÂÆπÂå∫ -->
                    <div class="sider-right-content">
                        <!-- ÊºÇÊµÆÂ∑•ÂÖ∑Ê†è -->
                        <FloatTool @choiceItem="choicePopButton"></FloatTool>
                        <div
                            v-if="showSiderRight"
                            @click="stowTheSide"
                            class="fold-button"
                            title="Êî∂Ëµ∑Âè≥‰æß Ctrl+Shift+]"
                        >
                            <icon-right :stroke-width="2" />
                        </div>
                        <!-- ÂêÑ‰∏™ÈúÄË¶ÅÊòæÁ§∫ÁöÑÁªÑ‰ª∂ -->
                        <WebviewBlock v-if="showModular === '0'" ref="webviewBlockRef"></WebviewBlock>
                        <PlotEditor v-if="showModular === '1'"></PlotEditor>
                        <KeywordEditor
                            v-if="showModular === '2'"
                            @kChange="changeKeyWordState"
                            ref="keyWordRef"
                        ></KeywordEditor>
                        <DiagramEditor v-if="showModular === '3'"></DiagramEditor>
                        <TimelineEditor v-if="showModular === '4'" ref="ref_TimelineEditor"></TimelineEditor>
                        <MapContent v-if="showModular === '5'"></MapContent>
                        <div v-if="showIframeWrap" class="right-Wrap"></div>
                    </div>
                </a-resize-box>
            </a-layout>
        </a-layout>
    </div>
</template>

<script setup lang="ts">
import { ref, onUnmounted, reactive, onMounted, nextTick, onBeforeUnmount, Ref } from 'vue';
import { IconCaretRight, IconCaretLeft, IconRightCircle, IconLeft, IconRight } from '@arco-design/web-vue/es/icon';
import { useRoute } from 'vue-router';
import TitleBlock from '../components/TitleBlock.vue';
import TopToolbar from '../components/TopToolbar.vue';
import WritingPaper from '../components/WritingPaper.vue';
import PopupMenu from '../components/widget/PopupMenu.vue';
import WebviewBlock from '../components/WebviewBlock.vue';
import PlotEditor from '../components/PlotEditor.vue';
import KeywordEditor from '../components/KeywordEditor.vue';
import DiagramEditor from '../components/DiagramEditor.vue';
import TimelineEditor from '../components/TimelineEditor.vue';
import MapContent from '../components/MapContent.vue';
import KeywordDetail from '../components/widget/KeywordDetail.vue';
import FloatTool from '../components/widget/FloatTool.vue';
import SearchBox from '../components/widget/SearchBox.vue';
import useCurrentInstance from '../utils/useCurrentInstance';
import { throttle } from '../utils/flowControl';
import genkeywordMarks from '../utils/genkeywordMarks';
import { useMainStore } from '../store/index';
import { saveTodaysCodewords } from '../hooks/db';
import { db } from '../db/db';
import { v4 } from 'uuid';
import '../style/writerPage.scss';

const { proxy } = useCurrentInstance();
const mainStore = useMainStore();
const $modal = proxy.$modal;
const $message = proxy.$message;
const route = useRoute();
const query_id = parseInt(<string>route.query.id);
const vid = ref(route.query.vid); // ÁºìÂ≠òÂΩìÂâçÂç∑vid
const cid = ref(route.query.cid); // ÁºìÂ≠òÂΩìÂâçÁ´†cid
const paperRef = ref(); // Á∫∏Âº†
const topToolRef = ref(); // È°∂ÈÉ®Â∑•ÂÖ∑Ê†è
const searchBoxRef = ref(); // ÊêúÁ¥¢Ê°Ü
const showIframeWrap = ref(false); // ÈÅÆÁΩ©
const keywordMarks: Ref<Array<Marker>> = ref([]);
loadListData();

// ËΩ¨ÂèëÁ∫∏Âº†-->Â§¥ÈÉ®Â∑•ÂÖ∑Ê†èÁöÑÊï∞ÊçÆ
const sendPaperData = (data: Pagecount) => {
    topToolRef.value.getData(data);
}

// Â∑¶‰æßÊòØÂê¶ÊäòÂè†
const isCollapse = ref(false);
const onCollapse = (val: boolean) => {
    isCollapse.value = val;
}

// Â∑¶Ê†èÂ±ïÂºÄÊõ¥Â§öÊìç‰Ωú
const editVid1 = ref(''), editVid2 = ref(''), editVid3 = ref('');
const showLeftMore = ref('');

// ÁÇπÂáªÂ∑¶‰æßÈ°πÁõÆÂàáÊç¢Á´†ËäÇ
const onClickMenuItem = (tvid: string, tcid: string) => {
    if (tcid !== cid.value) {
        vid.value = tvid;
        cid.value = tcid;
        paperRef.value.setId(tvid, tcid);

        // Âä†ËΩΩÊñ∞Êï∞ÊçÆ
        loadListData(() => {
            // ÊêúÁ¥¢Ê°ÜÁä∂ÊÄÅ
            if (showSearchBox.value) {
                // ÊêúÁ¥¢Ê°ÜÊòæÁ§∫ÔºåÈáçÊñ∞ÊêúÁ¥¢ÂàáÊç¢ÂêéÈ°µÈù¢ÁöÑÂÖ≥ÈîÆÂ≠ó
                mainStore.targetIndex = 1;
                searchBoxRef.value.toSearchKeyword();
            }
        });
    }
}

// ÂÖ≥Èó≠ÊêúÁ¥¢Ê°Ü
const showSearchBox = ref(false);
const closeSearch = () => {
    showSearchBox.value = false;
    db.opus.get(query_id).then(value => {
        if (value) paperRef.value.setBooksData(value, keywordMarks.value);
    })
}

// Âç∑Á´†ÈáçÂëΩÂêç
const isRename = ref(false), showName = ref('');
let temp_id: string, reType: string = '';
const showReName = (type: string, id: string, vname: string) => {
    isRename.value = true;
    reType = type; // ÈáçÂëΩÂêçÁ±ªÂûã
    temp_id = id;
    showName.value = vname;
}
const reName = () => {
    // ‰øÆÊîπÂç∑
    if (reType === 'v') {
        loadDB((item: Userdb) => {
            const len = item.data.length;
            for (let i = 0; i < len; i++) {
                if (item.data[i].vid === temp_id) {
                    item.data[i].volumeName = showName.value;
                    break;
                }
            }
        })
    }
    // ‰øÆÊîπÁ´†
    else if (reType === 'c') {
        loadDB((item: Userdb) => {
            const len1 = item.data.length;
            for (let i = 0; i < len1; i++) {
                const len2 = item.data[i].volume.length;
                for (let j = 0; j < len2; j++) {
                    if (item.data[i].volume[j].cid === temp_id) {
                        item.data[i].volume[j].chapterName = showName.value;
                        break;
                    }
                }
            }
        })
    }

    // Â±ÄÈÉ®ÊñπÊ≥ï
    function loadDB(cb: Function) {
        db.opus.where(':id').equals(query_id).modify(item => {
            cb(item);
        }).then(() => {
            isRename.value = false;
            loadListData();
        })
    }
}

// Âà†Èô§Âç∑ÔºàÁßªËá≥Â∫üÁ∫∏ÁØìÔºâ
const deleteVolume = (vid: string, vname: string) => {
    $modal.warning({
        title: "Âà†Èô§Âç∑",
        content: `ÁõÆÊ†áÂç∑„Äê${vname}„ÄëÂ∞ÜÊîæÂÖ•Â∫üÁ∫∏ÁØì,Âπ∂‰øùÁïô30Â§©`,
        simple: true,
        onOk: () => {
            db.opus.where(':id').equals(query_id).modify(item => {
                const len = item.data.length;
                for (let i = 0; i < len; i++) {
                    if (item.data[i].vid === vid) {
                        item.data[i].discard = true;
                        item.data[i].discardTime = new Date().getTime();
                        break;
                    }
                }
            }).then(() => {
                loadListData();
                $message.success('Âà†Èô§ÊàêÂäü!');
            })
        }
    })
}

// Âà†Èô§Á´†ÔºàÁßªËá≥Â∫üÁ∫∏ÁØìÔºâ
const deletedCid = ref('');
const deleteChapter = (dvid: string, dcid: string, cname: string) => {
    $modal.warning({
        title: "Âà†Èô§Á´†",
        content: `ÁõÆÊ†áÁ´†„Ää${cname}„ÄãÂ∞ÜÊîæÂÖ•Â∫üÁ∫∏ÁØì,Âπ∂‰øùÁïô30Â§©`,
        simple: true,
        onOk: () => {
            db.opus.where(':id').equals(query_id).modify(item => {
                const len1 = item.data.length
                for (let i = 0; i < len1; i++) {
                    if (item.data[i].vid === dvid) {
                        const len2 = item.data[i].volume.length;
                        for (let j = 0; j < len2; j++) {
                            if (item.data[i].volume[j].cid === dcid) {
                                item.data[i].volume[j].discard = true;
                                item.data[i].volume[j].discardTime = new Date().getTime();
                                break;
                            }
                        }
                        break;
                    }
                }
            }).then(() => {
                // Âà†Èô§ÁöÑÁõÆÊ†áÊòØÂΩìÂâçÁºñËæëÁöÑÁõÆÊ†á
                if (dvid === vid.value && dcid === cid.value) {
                    deletedCid.value = dcid;
                    paperRef.value.refreshPaper([{
                        type: "paragraph",
                        content: [{
                            type: "text",
                            text: ''
                        }]
                    }]);
                } else {
                    loadListData();
                }
                $message.success('Âà†Èô§ÊàêÂäü!');
            })
        }
    })
}

// ÁÇπÂáªÊ∑ªÂä†Á´†
const isNewChapter = ref(false), chapterName = ref('Êú™ÂëΩÂêçÁ´†');
let volumeId: string; // ÊâæÂà∞ÁõÆÊ†áÂç∑ÊâçËÉΩÂêëÈáåÈù¢pushÁ´†
const newChapter = (vid: string) => {
    volumeId = vid;
    isNewChapter.value = true;
}
const addNewChapter = () => {
    db.opus.where(':id').equals(query_id).modify(item => {
        const len = item.data.length;
        for (let i = 0; i < len; i++) {
            if (item.data[i].vid === volumeId) {
                item.data[i].volume.push({
                    cid: v4(),
                    chapterName: chapterName.value,
                    updateTime: new Date().getTime(),
                    chapter: ['\u3000\u3000'] // ‰∏§‰∏™‰∏≠ÊñáÁ©∫Ê†º
                });
                break;
            }
        }
    }).then(() => {
        isNewChapter.value = false;
        loadListData();
        $message.success('Ê∑ªÂä†ÊàêÂäü!');
    })
}

// ÁÇπÂáªÊ∑ªÂä†Âç∑
const isNewVolume = ref(false), volumeName = ref('Êú™ÂëΩÂêçÂç∑');
const addNewVolume = () => {
    db.opus.where(':id').equals(query_id).modify(item => {
        item.data.push({
            vid: v4(),
            volumeName: volumeName.value,
            updateTime: new Date().getTime(),
            volume: [{
                cid: v4(),
                chapterName: 'Êú™ÂëΩÂêçÁ´†',
                updateTime: new Date().getTime(),
                chapter: ['\u3000\u3000'] // ‰∏§‰∏™‰∏≠ÊñáÁ©∫Ê†º
            }]
        });
    }).then(() => {
        isNewVolume.value = false;
        loadListData();
        $message.success('Ê∑ªÂä†ÊàêÂäü!');
    })
}

// Âè≥‰æßÊªöÂä®Êù°ÁöÑÊ†∑ÂºèËÆæÁΩÆ
const scrollbarColor = ref('#ccc');
const showScroll = () => {
    scrollbarColor.value = 'var(--scrollbar-color)';
}
const closeScroll = () => {
    scrollbarColor.value = 'rgb(var(--my-bg-color))';
}

// Ë∞ÉÊï¥Âè≥‰æßÂ∞èÁ™óÂè£Â§ßÂ∞è
const ref_TimelineEditor = ref();
const resizeBoxMoving = () => {
    if (ref_TimelineEditor.value) ref_TimelineEditor.value.setSliderState();
    // ÂÖ≥Èó≠ÊÇ¨ÊµÆÂç°Áâá
    if (showkeywordDetail.value) showkeywordDetail.value = false;
}

// Âè≥‰æßPopButtonÔºåÈÄâÊã©Âπ∂Ê∏≤ÊüìÂØπÂ∫îÁªÑ‰ª∂
const showModular = ref('0');
if (localStorage.getItem('showModular') === null) {
    localStorage.setItem('showModular', '0');
} else {
    showModular.value = localStorage.getItem('showModular') ?? '0';
}
const choicePopButton = (key: string) => {
    showModular.value = key;
    localStorage.setItem('showModular', key);
}

const modify = () => {
    isRename.value = false;
    isNewVolume.value = false;
    isNewChapter.value = false;
}

// ÂÖ≥ÈîÆÂ≠óÈù¢ÊùøÁä∂ÊÄÅÊîπÂèò
const changeKeyWordState = () => {
    loadListData();
}

// ‰ΩøÁî®webviewÂø´Êç∑ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
const webviewBlockRef = ref();
const toWebView = (str: string) => {
    showSiderRight.value = true;
    // ÂΩìÂâçÊòæÁ§∫‰∫Üwebview
    if (webviewBlockRef.value) {
        webviewBlockRef.value.toSearch(str);
    }
    // ÂΩìÂâçÊ≤°ÊúâÊòæÁ§∫webview
    else {
        showModular.value = '0'; // ÂàôÊòæÁ§∫
        nextTick(() => {
            webviewBlockRef.value.toSearch(str);
        })
    }
}

// Êé†ËøáÂÖ≥ÈîÆËØçÊòæÁ§∫Âç°Áâá
const showkeywordDetail = ref(false),
    keywordDetailRef = ref(), // Âç°ÁâáÁªÑ‰ª∂ÂÆû‰æã
    keywordDetail = ref(); // Âç°ÁâáÊ†πDOM
// Ëé∑ÂæóÂ∞èÂç°ÁâáÁöÑÊ†πDOMÂÖÉÁ¥†
const getkeywordDetail = (tarDOM: HTMLElement) => {
    keywordDetail.value = tarDOM;
}
// Â§ÑÁêÜÊï∞ÊçÆÂπ∂ÊòæÁ§∫Âç°ÁâáÊï∞ÊçÆ
let currentKid = '', currentIid = '';
const showSpanDetail = throttle((e: MouseEvent) => {
    // Á°ÆËÆ§ÁõÆÊ†á
    if ((<HTMLElement>e.target).getAttribute('class') === 'keyWord') {
        showkeywordDetail.value = true; // ÊòæÁ§∫
        const targetText = (<HTMLElement>e.target).innerText;
        let posX: number, posY: number, domRect = (<HTMLElement>e.target).getBoundingClientRect();
        [posX, posY] = [domRect.x + domRect.width, domRect.y + domRect.height];
        // Ëé∑ÂèñÁõÆÊ†áÊï∞ÊçÆ
        keyWordArr.forEach(item => {
            const len = item.length;
            for (let i = 2; i < len; i++) {
                if (item[i] === targetText) {
                    [currentKid, currentIid] = [item[0], item[1]];
                    modifyDbforItem(item[0], item[1], (item: KeyWord) => {
                        // Â∞ÜÊï∞ÊçÆ‰∫§ÁªôÂç°ÁâáÁªÑ‰ª∂
                        keywordDetailRef.value.getCurrentKeyword(item);
                    })
                    break;
                }
            }
        })
        nextTick(() => {
            keywordDetail.value.style.top = posY - keywordDetail.value.clientHeight / 2 - domRect.height / 2 + 'px';
            keywordDetail.value.style.left = posX + 10 + 'px';
            // Èº†Ê†áÁ¶ªÂºÄÂç°ÁâáÔºåÂç°ÁâáÊ∂àÂ§±
            keywordDetail.value.onmouseleave = (e: MouseEvent) => {
                showkeywordDetail.value = (<HTMLElement>e.relatedTarget).className === 'arco-trigger-content arco-popover-popup-content';
                const arco_trigger_popup = document.querySelector('.arco-trigger-popup');
                if (arco_trigger_popup) {
                    (<HTMLElement>arco_trigger_popup).onclick = (e: MouseEvent) => {
                        e.stopPropagation();
                    }
                }
            }
        })
    } else {
        showkeywordDetail.value = false;
    }
}, 50);

// ÁÇπÂáªÂ∞èÈ£ûÊú∫Âø´ÈÄüËΩ¨Âà∞ÂÖ≥ÈîÆÂ≠óÈù¢Êùø
const keyWordRef = ref();
const displayKeyPanel = () => {
    // ÊòæÁ§∫ÂÖ≥ÈîÆËØçÊ®°Âùó
    showModular.value = '2';
    nextTick(() => {
        // ÂÖ≥ÈîÆËØçÊ®°ÂùóÊòæÁ§∫ÂÖ∑‰ΩìÈ°πÁõÆ
        keyWordRef.value.needShowDetailPanel(currentKid, currentIid);
    })
}

// ÊéßÂà∂ÂÖ®Â±èÊ®°Âºè
const fullScreenState = ref(false);
//ÂÖ®Â±èÁä∂ÊÄÅÔºåÈªòËÆ§ÁöÑÊ†∏ÂøÉÂå∫È´òÂ∫¶
const layoutWriteHeight = ref('calc(100vh - 80px)');
const turnfullScreen = (state: boolean) => {
    window.$API.ipcSend('fullscreen', state);
    window.$API.ipcOnce('isFullScreen', (state: boolean) => {
        // ËÉΩÂê¶ÂÖ®Â±è
        fullScreenState.value = state;
        // Ëã•ÂÖ®Â±èÔºåÂÖ≥Èó≠Âè≥‰æß
        if (state) {
            stowTheSide();
        }
        // Âê¶ÂàôÂºÄÂêØÂè≥‰æß
        else {
            openTheSide();
        }

        // Ëã•ÂÖ®Â±èÔºåÊäòÂè†Â∑¶‰æß
        isCollapse.value = state;
        // ‰øÆÊ≠£È´òÂ∫¶ÔºåÈöêËóèÈ°∂Ê†è
        if (state) {
            layoutWriteHeight.value = 'calc(100vh - 5px)';
        } else {
            layoutWriteHeight.value = 'calc(100vh - 80px)';
        }
    })
}

// Á∫∏Âº†ÁªÑ‰ª∂"Âø´Êç∑Ê∑ªÂä†"ÂÖ≥ÈîÆËØçÊó∂Ëß¶Âèë
const addKeyWord = () => {
    // Â¶ÇÊûúÂΩìÂâçÊòæÁ§∫‰∫ÜÂÖ≥ÈîÆÂ≠óÈù¢ÊùøÔºåÂàôÈÄöÁü•ÂÖ∂Âà∑Êñ∞Êï∞ÊçÆ
    if (showModular.value === '2') {
        keyWordRef.value.loadKeyWodData();
    } else {
        loadListData();
    }
}

// Êî∂Ëµ∑Âè≥‰æß‰º∏Áº©Ê†è
const resizeBoxWdith = ref(525), showSiderRight = ref(true);
const stowTheSide = () => {
    showSiderRight.value = false;
}
const openTheSide = () => {
    showSiderRight.value = true;
}

// Ëé∑ÂèñÈ°µÈù¢‰∏ä‰∏ãÁõ∏ÂØπ‰ΩçÁΩÆÂπ∂‰øùÂ≠ò
let tempScrollTop = 0; // ÊîæÂú®Â§ñÈù¢ÊâçËÉΩ‰øùËØÅÁõÆÂâç‰øùÂ≠òÁöÑÊòØÊúÄÊñ∞ÁöÑ
const getScrollTop = (e: Event) => {
    tempScrollTop = (<HTMLElement>e.target).scrollTop ?? 0;
    if (showkeywordDetail.value) showkeywordDetail.value = false; // ÂÖ≥Èó≠ÊÇ¨ÊµÆÂç°Áâá
    setScrollTop();
}
const setScrollTop = throttle(() => {
    db.opus.where(':id').equals(query_id).modify(item => {
        item.data.forEach(item => {
            if (item.vid === vid.value) {
                item.volume.forEach(it => {
                    if (it.cid === cid.value) it.scrollTop = tempScrollTop;
                })
            }
        })
    })
}, 500);

// Ëé∑ÂèñÂàóË°®Êï∞ÊçÆ
const booksLists: { data: Array<Volume> } = reactive({ data: [] });
let keyWordArr: Array<Array<string>> = [];
function loadListData(cb?: Function): void {
    db.opus.get(query_id).then(value => {
        if (value) {
            // Âä†ËΩΩÂÖ≥ÈîÆËØç
            keyWordArr = [];
            value.theKeyWord.forEach(item => {
                let tempArr: Array<string> = [];
                item.data.forEach(it => {
                    tempArr = it.otherName;
                    // kid iid ÊúâÂÖ∂ÂÆÉÁî®Â§Ñ genkeywordMarks‰ºöÂøΩÁï•
                    tempArr.unshift(item.kid, it.iid, it.itemName);
                    // ÂéªÈáç
                    keyWordArr.push([...new Set(tempArr)]);
                })
            })
            // Ê∏≤ÊüìÂÖ≥ÈîÆËØç
            keywordMarks.value = genkeywordMarks(keyWordArr);
            (<Array<Marker>>mainStore.keywordMarks) = keywordMarks.value;
            paperRef.value.setBooksData(value, keywordMarks.value);

            // Âä†ËΩΩÂç∑Á´†ÂàóË°®
            booksLists.data = value.data.filter((item: Volume) => {
                // Âà§Êñ≠ÁõÆÊ†áÂç∑ÊòØÂê¶ÊúâÂà†Èô§Ê†áËÆ∞
                return !item.discard;
            });
            booksLists.data.forEach((item: Volume) => {
                item.volume = item.volume.filter((it: Chapter) => {
                    // Âà§Êñ≠ÁõÆÊ†áÁ´†ÊòØÂê¶ÊúâÂà†Èô§Ê†áËÆ∞
                    return !it.discard;
                })
            });

            // ËÆæÁΩÆÈªòËÆ§ÁöÑscrollTop
            const len1 = booksLists.data.length;
            for (let i = 0; i < len1; i++) {
                if (booksLists.data[i].vid === vid.value) {
                    const len2 = booksLists.data[i].volume.length;
                    for (let j = 0; j < len2; j++) {
                        if (booksLists.data[i].volume[j].cid === cid.value) {
                            (<HTMLElement>document.querySelector('.arco-layout-content')).scrollTop =
                                <number>booksLists.data[i].volume[j].scrollTop;
                            break;
                        }
                    }
                    break;
                }
            }
        }
    }).then(() => {
        if (typeof cb === 'function') cb();
    })
}

// Ëá™ÂÆö‰πâÂÖ®Â±ÄÂø´Êç∑ÈîÆ
window.addEventListener('click', leftMoreControl);
function leftMoreControl(): void {
    showLeftMore.value = '';
}
window.addEventListener('keydown', shortcut);
function shortcut(e: KeyboardEvent) {
    if (deletedCid.value === cid.value) {
        // Ctrl+s
        if (e.ctrlKey === true && e.key === 's') $message.error('ÁõÆÊ†áÂ∑≤Ë¢´Âà†Èô§!');
    } else {
        // Ctrl+s
        if (e.ctrlKey === true && e.key === 's') paperRef.value.saveDocData('‰øùÂ≠òÊàêÂäüÔºÅ');
        // Ctrl+f
        if (e.ctrlKey === true && e.key === 'f') {
            showSearchBox.value = true;
            nextTick(() => {
                // ÊääÂÖ≥ÈîÆÂ≠óÊ†áËÆ∞ÂíåÁ∫∏Âº†refÁªôÊêúÁ¥¢Ê°Ü
                searchBoxRef.value.setData(keywordMarks, paperRef.value);
            })
        }
    }
    // ÊãâÂºÄ/Áº©Á¥ßÂè≥‰æßÊ†è Ctrl+[/]
    if (e.ctrlKey === true && e.key === '[') {
        console.log('ÊãâÂºÄ');
        if (showSiderRight.value && resizeBoxWdith.value < window.innerWidth - 200) resizeBoxWdith.value += 100;
    }
    if (e.ctrlKey === true && e.key === ']') {
        console.log('ÂÖ≥Èó≠');
        if (showSiderRight.value && resizeBoxWdith.value > 250) resizeBoxWdith.value -= 100;
    }
    // Â±ïÂºÄ/ÂÖ≥Èó≠Âè≥‰æßÊ†è Ctrl+{/}(Ctrl+Shift+[/])
    if (e.ctrlKey === true && e.key === '{') {
        openTheSide();
    }
    if (e.ctrlKey === true && e.key === '}') {
        stowTheSide();
    }
    // ÊâìÂºÄÂÖ®Â±èÊ®°Âºè
    if (e.key === 'F1') {
        turnfullScreen(true);
    }
    // ÂÖ≥Èó≠ÂÖ®Â±èÊ®°Âºè
    if (e.key === 'Escape') {
        turnfullScreen(false);
    }
}

// ÊâæÂà∞ÂÖ≥ÈîÆÂ≠óÊï∞ÊçÆ
function modifyDbforItem(t_kid: string, t_iid: string, hd: Function, cb?: Function): void {
    db.opus.where(':id').equals(query_id).modify(item => {
        item.theKeyWord.forEach(item => {
            if (item.kid === t_kid) {
                item.data.forEach(it => {
                    if (it.iid === t_iid) hd(it);
                })
            }
        })
    }).then(() => {
        if (cb) cb();
    })
}

// ÁîüÂëΩÂë®Êúü 
onMounted(() => {
    // Â∞ÜÁ∫∏Âº†ÁöÑrefÁªôÂ§¥ÈÉ®Â∑•ÂÖ∑Ê†è
    topToolRef.value.getPaperRef(paperRef.value);
    // ÊòæÁ§∫ÂÖ≥ÈîÆÂ≠óÂ∞èÂç°Áâá
    const mainEditor = document.getElementById('mainEditor-w');
    window.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.ctrlKey) mainEditor?.addEventListener('mousemove', showSpanDetail);
    });
    window.addEventListener('keyup', (e: KeyboardEvent) => {
        if (!e.ctrlKey) mainEditor?.removeEventListener('mousemove', showSpanDetail);
    })
    // Â±èÂπïÂ§ßÂ∞èÊîπÂèòÊó∂ÂÖ≥Èó≠ÊÇ¨ÊµÆÂç°Áâá
    window.onresize = () => {
        showkeywordDetail.value = false;
    }
    // ÁÇπÂáª‰ªªÊÑèÂú∞ÊñπÂÖ≥Èó≠ÊÇ¨ÊµÆÂç°ÁâáÔºàÁõÆÊ†áÂç°ÁâáÁ¶ÅÁî®ÂÜíÊ≥°
    window.addEventListener('click', () => {
        if (showkeywordDetail.value) showkeywordDetail.value = false;
    });
})
onBeforeUnmount(() => {
    // Êõ¥Êñ∞ÁªßÁª≠ÂÜô‰ΩúÂØπÂ∫îÁöÑvid_cid
    db.opus.update(query_id, { historRecord: { vid: vid.value, cid: cid.value } });
    saveTodaysCodewords();
})
onUnmounted(() => {
    window.removeEventListener('keydown', shortcut);
    window.removeEventListener('click', leftMoreControl);
})

</script>

<style scoped>
::-webkit-scrollbar-track {
    box-shadow: none;
    border-radius: 0;
    border-left: 1px dashed var(--color-border);
}
::-webkit-scrollbar-thumb {
    background-color: v-bind(scrollbarColor);
    border-radius: 0;
    border-left: 1px dashed var(--color-border);
}
.trigger::-webkit-scrollbar-thumb {
    background-color: rgb(var(--my-bg2-color));
}
.layout-write :deep(.arco-layout-header) {
    height: 35px;
    border-bottom: 2px dashed var(--color-border);
    background-color: rgb(var(--my-bg-color));
}

.layout-write :deep(.arco-layout-content) {
    height: v-bind(layoutWriteHeight);
    min-width: 20px;
    background-color: rgb(var(--my-bg-color));
    overflow-y: scroll;
}
</style>